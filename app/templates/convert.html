<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>

<body class="container-sm fs-6 d-flex flex-column justify-content-center" style="height: 100vh; ">
    <section id="send-section" class="d-flex flex-column align-items-center gap-4">
        <form action="" method="post" enctype="multipart/form-data" class="d-flex flex-column"
            style="max-width: 600px; gap: 20px">

            <div>
                <legend for="database" class="fs-6 form-label">имя базы данных</legend>

                <input required class="form-control" type="text" id="database" name="database">
            </div>

            <fieldset>
                <legend class="fs-6">Адрес для подключения</legend>

                <div class="input-group">
                    <input required class="form-control" type="text" name="host" id="host" placeholder="имя хоста с бд">
                    <span class="input-group-text">:</span>
                    <input required class="form-control" type="number" name="port" id="port" placeholder="порт">
                </div>
            </fieldset>

            <fieldset>
                <legend class="fs-6">Логин и пароль для подключения к бд</legend>
                <div class="input-group">

                    <input class="form-control " type="text" name="user" id="user" placeholder="пользователь">
                    <span class="input-group-text">:</span>
                    <input class="form-control " type="password" name="password" id="password" placeholder="пароль">

                </div>
            </fieldset>

            <fieldset>
                <label class="form-label" for="access_file">access файл</label>
                <input type="file" name="access_file" id="access_file" class="form-control" required
                    accept=".mdb,.accdb">

            </fieldset>

            <input type="submit" value="Отправить" class="btn btn-primary">
        </form>
    </section>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

<script>
    console.log("init")


    const database = localStorage.getItem("database");
    const host = localStorage.getItem("host");
    const port = localStorage.getItem("port");
    const user = localStorage.getItem("user");

    
    const sectionElement = document.querySelector('#send-section');
    const inputDatabase = document.querySelector('#database');
    const inputHost = document.querySelector("#host");
    const inputPort = document.querySelector("#port");
    const inputUser = document.querySelector("#user");
    if (database) inputDatabase.value = database;
    if (host) inputHost.value = host;
    if (port) inputPort.value = port;
    if (user) inputUser.value = user;


    document.querySelector('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Save form values to localStorage
        localStorage.setItem('database', document.querySelector('#database').value || "");
        localStorage.setItem('host', document.querySelector('#host').value || "");
        localStorage.setItem('port', document.querySelector('#port').value || "");
        localStorage.setItem('user', document.querySelector('#user').value || "");

        const formData = new FormData();

        formData.append('database', localStorage.getItem('database'));
        formData.append('host', document.getElementById('host').value);
        formData.append('port', document.getElementById('port').value);
        formData.append('user', document.getElementById('user').value);
        formData.append('password', document.getElementById('password').value);
        formData.append('access_file', document.getElementById('access_file').files[0]);

        try {
            const response = await fetch('/convert', {
                method: 'POST',
                body: formData
            });

            // const result = await response.json();
            // console.log('json response:', result);
            const blob = await response.blob();
            const downloadUrl = URL.createObjectURL(blob);
            const btn = document.createElement('button');
            btn.classList.add("btn", "btn-success", "mt-8");
            const a = document.createElement('a');
            a.classList.add("text-white", "text-decoration-none");
            btn.appendChild(a);
            a.href = downloadUrl;
            a.download = 'converted_db.zip';
            a.text = "Скачать архив";
            
            sectionElement.appendChild(btn);
            a.click();

            if (!response.ok) {
                console.error("error:", result);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
</script>